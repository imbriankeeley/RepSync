# RepSync Update Plan — February 24, 2026

## Overview

8 features to implement across the RepSync Android app. Recommended order minimizes conflicts and handles dependencies (DB migration in Feature 7 must come before Feature 8's drag reorder can share the library).

---

## Implementation Order

| # | Feature | Complexity | Migration? |
|---|---------|-----------|------------|
| 1 | Anime GIFs on Home Screen | Low | No |
| 2 | Rest Timer — Louder, Longer, Background | High | No |
| 3 | Calendar Day → DayView Set Details | Low | No |
| 4 | Keyboard Scroll Behavior | Low | No |
| 5 | Move Streak Counter to Profile | Low | No |
| 6 | Bodyweight Entries Separate Page | Medium | No |
| 7 | Drag to Reorder Workouts | Medium-High | Yes (v2→v3) |
| 8 | Drag to Reorder Exercises | Medium | No |

---

## Feature 1: Anime GIFs on Home Screen

**Goal:** Replace workout GIFs with 40 sexy SFW anime girl GIFs. Rotate on every app open (not daily).

**Current behavior:**
- `MotivationalGif.kt` has 15 hardcoded Giphy URLs
- Daily rotation: `dayOfYear % workoutGifs.size`
- Uses Coil with GIF decoder (already supports GIF loading)

**Changes:**
- Replace `workoutGifs` list (lines 40-56) with 40 sexy SFW anime girl GIF URLs from Giphy/Tenor
- Change rotation from `dayOfYear % size` to `Random.nextInt(workoutGifs.size)` without `remember` keyed to day — new GIF each time the composable is first composed (app open)
- Update fallback emojis to anime-themed
- Keep all Coil loading logic, ImageLoader, error handling unchanged

**Files:**
- `app/src/main/java/com/repsync/app/ui/components/MotivationalGif.kt`

---

## Feature 2: Rest Timer — Louder, Longer, Background

**Goal:** Rest timer alert works when app is backgrounded, phone screen off, or music playing. Louder sound, doubled duration.

**Current behavior:**
- `ActiveWorkoutManager.kt` runs timer via coroutine Job (`delay(1000L)` loop in `viewModelScope`)
- Alert: `ToneGenerator(STREAM_NOTIFICATION)` for 600ms + vibration pattern `[0,300,200,300,200,300]`
- Dies when app goes to background (viewModelScope pauses/cancels)

**Changes:**

### New files:
1. **`app/src/main/java/com/repsync/app/service/RestTimerState.kt`**
   - Singleton object with `MutableStateFlow<Int>` (secondsRemaining) and `MutableSharedFlow<Unit>` (timerCompleted)
   - Bridge between foreground service and UI

2. **`app/src/main/java/com/repsync/app/service/RestTimerService.kt`**
   - Foreground Service with `CountDownTimer` (not coroutine — more reliable in service context)
   - Notification channel: `"rest_timer_channel"`, HIGH importance
   - Shows persistent notification with countdown, updates every second
   - On completion: `MediaPlayer` on `AudioManager.STREAM_ALARM` at max volume for 1200ms (doubled from 600ms)
   - Vibration pattern: `[0, 400, 200, 400, 200, 400, 200, 400]` (stronger)
   - Handles `ACTION_STOP` intent to cancel early (Skip button)
   - Updates `RestTimerState` flows for UI sync
   - `stopSelf()` after completion

### Modified files:
3. **`AndroidManifest.xml`**
   - Add permissions: `FOREGROUND_SERVICE`, `FOREGROUND_SERVICE_SPECIAL_USE`
   - Register service: `<service android:name=".service.RestTimerService" android:foregroundServiceType="specialUse" android:exported="false" />`

4. **`ActiveWorkoutManager.kt`**
   - `startRestTimer()` → start `RestTimerService` via intent with `EXTRA_DURATION_SECONDS`
   - `dismissRestTimer()` → send `ACTION_STOP` intent to service
   - Observe `RestTimerState.secondsRemaining` to update UI state
   - Observe `RestTimerState.timerCompleted` for completion handling
   - Remove `restTimerJob`, `triggerVibration()`, `triggerSound()` methods

5. **`ActiveWorkoutScreen.kt`** — RestTimerBanner continues working as-is (reads from same UI state). "Skip" button sends stop intent via ViewModel.

**Why STREAM_ALARM:** Plays independently of media volume, works over music, respects alarm volume setting which users typically leave on.

---

## Feature 3: Calendar Day → DayView Set Details

**Goal:** Clicking a calendar day with a workout shows all exercises and sets (weight × reps) readonly.

**Current behavior:**
- Calendar day click already navigates to `DayView/{date}` (wired in `RepSyncNavHost.kt`)
- `DayViewScreen.kt` shows completed workouts but `ExerciseSummaryRow` only displays the best set (heaviest weight)
- Full set data is already loaded (`CompletedExerciseWithSets.sets: List<CompletedSetEntity>`)

**Changes:**
- Add `expandedExerciseIds: Set<Long>` to `DayViewUiState`
- Add `toggleExerciseExpanded(id)` method to `DayViewViewModel`
- In `ExerciseSummaryRow`: make row clickable to toggle expansion
- When expanded, show a Column of all sets: "Set 1: 135 × 10", "Set 2: 155 × 8", etc.
- Add a small expand/collapse chevron icon

**Files:**
- `app/src/main/java/com/repsync/app/ui/screens/DayViewScreen.kt`
- `app/src/main/java/com/repsync/app/ui/viewmodel/DayViewViewModel.kt`

---

## Feature 4: Keyboard Scroll Behavior

**Goal:** Content scrolls above keyboard when text input is focused.

**Current behavior:** No `imePadding()`, `WindowInsets`, or keyboard-aware scrolling anywhere. Keyboard covers inputs.

**Changes:**

1. **`MainActivity.kt`** — Add before `setContent`:
   ```kotlin
   WindowCompat.setDecorFitsSystemWindows(window, false)
   ```
   Add `.imePadding()` to Scaffold modifier.

2. **If Scaffold-level causes bottom nav issues**, apply `.imePadding()` per-screen instead:
   - `ActiveWorkoutScreen.kt` (weight/reps inputs)
   - `NewWorkoutScreen.kt` (workout name, exercise names)
   - `EditProfileScreen.kt` (display name, reminder)
   - `ProfileScreen.kt` (AddBodyweightDialog)

3. **Optional:** Add `BringIntoViewRequester` on focused TextFields in LazyColumn-based screens for auto-scroll to focused field.

**Files:**
- `app/src/main/java/com/repsync/app/MainActivity.kt`
- Screens with text inputs (modifier additions only)

---

## Feature 5: Move Streak Counter to Profile

**Goal:** Relocate streak badge from HomeScreen to ProfileScreen.

**Current behavior:**
- `StreakBadge` composable is `private` in `HomeScreen.kt` (lines 273-298)
- Displayed between calendar and motivational GIF (line 77)
- Streak calculated in `HomeViewModel.calculateStreak()` (lines 79-131)
- Uses `completedWorkoutDao.getDatesWithCompletedWorkouts()` + `workoutDaysPrefs.days`

**Changes:**

1. **Extract** `StreakBadge` to `app/src/main/java/com/repsync/app/ui/components/StreakBadge.kt` (public)

2. **Remove** from `HomeScreen.kt`:
   - Remove `StreakBadge(streak = uiState.currentStreak)` call (line 77)
   - Optionally remove `currentStreak` from `HomeUiState` and `calculateStreak()` from `HomeViewModel`

3. **Add to ProfileViewModel:**
   - Add `currentStreak: Int = 0` to `ProfileUiState`
   - Add streak observation + calculation (same logic as HomeViewModel)
   - ProfileViewModel already has access to `completedWorkoutDao` and `workoutDaysPrefs`

4. **Add to ProfileScreen:**
   - Place `StreakBadge(streak = uiState.currentStreak)` between profile card and bodyweight section

**Files:**
- New: `app/src/main/java/com/repsync/app/ui/components/StreakBadge.kt`
- Modify: `HomeScreen.kt`, `ProfileScreen.kt`, `ProfileViewModel.kt`
- Optionally: `HomeViewModel.kt` (cleanup)

---

## Feature 6: Bodyweight Entries Separate Page

**Goal:** "View All Entries" button on Profile → scrollable page with date range filter, edit weight, delete.

**Current behavior:**
- Inline recent entries list in `ProfileScreen.kt` BodyweightSection (reversed chronological, delete only)
- `BodyweightDao` has `insert`, `delete`, `getAllEntriesChronological`, `getLatestEntry` — no update

**Changes:**

1. **`BodyweightDao.kt`** — Add:
   ```kotlin
   @Query("UPDATE bodyweight_entries SET weight = :weight WHERE id = :id")
   suspend fun updateWeight(id: Long, weight: Double)
   ```

2. **`Screen.kt`** — Add route:
   ```kotlin
   data object BodyweightEntries : Screen("bodyweight_entries")
   ```

3. **New `BodyweightEntriesViewModel.kt`:**
   - State: entries, filteredEntries, dateRange, editingEntry, showEditDialog
   - Observes `bodyweightDao.getAllEntriesChronological()` (display reversed)
   - Date range filter: parse `entry.date` as `LocalDate`, check within range
   - Methods: setDateRange, clearDateRange, showEditDialog, updateWeight, deleteEntry

4. **New `BodyweightEntriesScreen.kt`:**
   - Header: back arrow + "Bodyweight Entries"
   - Date range filter button (follow `ExerciseHistoryScreen` pattern)
   - LazyColumn of entries: date, weight + "lbs", edit icon, delete icon
   - Edit dialog: pre-filled weight input, save/cancel
   - Dark theme styling matching existing screens

5. **`RepSyncNavHost.kt`** — Add composable route

6. **`ProfileScreen.kt`:**
   - Add `onNavigateToBodyweightEntries` parameter
   - Remove inline entries list from BodyweightSection
   - Add "View All Entries" button
   - Keep chart and "+" add button on Profile

**Files:**
- New: `BodyweightEntriesScreen.kt`, `BodyweightEntriesViewModel.kt`
- Modify: `BodyweightDao.kt`, `Screen.kt`, `RepSyncNavHost.kt`, `ProfileScreen.kt`

---

## Feature 7: Drag to Reorder Workouts

**Goal:** Long-press + drag workouts to reorder them on the workouts list screen.

**Current behavior:**
- `WorkoutEntity` has: `id`, `name`, `createdAt` — no `orderIndex`
- DAO orders by `createdAt DESC`
- `WorkoutsListScreen` uses plain `LazyColumn`

**Changes:**

1. **`build.gradle.kts`** — Add dependency:
   ```kotlin
   implementation("sh.calvin.reorderable:reorderable:2.4.3")
   ```

2. **`WorkoutEntity.kt`** — Add field:
   ```kotlin
   val orderIndex: Int = 0
   ```

3. **`RepSyncDatabase.kt`** — Room migration v2→v3:
   ```kotlin
   private val MIGRATION_2_3 = object : Migration(2, 3) {
       override fun migrate(db: SupportSQLiteDatabase) {
           db.execSQL("ALTER TABLE workouts ADD COLUMN orderIndex INTEGER NOT NULL DEFAULT 0")
           db.execSQL("""
               UPDATE workouts SET orderIndex = (
                   SELECT COUNT(*) FROM workouts w2 WHERE w2.createdAt > workouts.createdAt
               )
           """)
       }
   }
   ```
   Bump version to 3, add migration to builder.

4. **`WorkoutDao.kt`:**
   - Change all `ORDER BY createdAt DESC` → `ORDER BY orderIndex ASC`
   - Add `updateWorkoutOrder(id: Long, orderIndex: Int)`
   - Add `getWorkoutCount(): Int`

5. **`WorkoutsListViewModel.kt`:**
   - Add `moveWorkout(fromIndex, toIndex)` — reorder in-memory list
   - Add `saveWorkoutOrder()` — persist all orderIndex values
   - Disable reorder when search is active

6. **`WorkoutsListScreen.kt`:**
   - Replace LazyColumn with reorderable version (library API)
   - Wrap `WorkoutListItem` in `ReorderableItem`
   - Long-press to drag, visual feedback (elevation/alpha)
   - On drag end → `saveWorkoutOrder()`
   - Normal LazyColumn when search active

7. **`NewWorkoutViewModel.kt`:**
   - New workouts get `orderIndex = workoutDao.getWorkoutCount()`

**Files:**
- `build.gradle.kts`, `WorkoutEntity.kt`, `RepSyncDatabase.kt`, `WorkoutDao.kt`
- `WorkoutsListViewModel.kt`, `WorkoutsListScreen.kt`, `NewWorkoutViewModel.kt`

---

## Feature 8: Drag to Reorder Exercises

**Goal:** Long-press + drag exercises to reorder them within a workout (edit/create screen).

**Current behavior:**
- `ExerciseEntity` already has `orderIndex: Int` — no migration needed
- `NewWorkoutViewModel` assigns `orderIndex = exerciseIndex` during save (`forEachIndexed`)
- `NewWorkoutScreen` uses LazyColumn with `itemsIndexed`

**Changes:**

1. **`NewWorkoutViewModel.kt`:**
   - Add `moveExercise(fromIndex, toIndex)` — reorder exercises list in-memory
   - Order is automatically saved correctly since `saveWorkout()` uses `forEachIndexed`

2. **`NewWorkoutScreen.kt`:**
   - Replace exercise items in LazyColumn with reorderable items
   - Long-press to drag (or add a drag handle icon)
   - On move → `viewModel.moveExercise(from, to)`
   - Exercise items use `exercise.id` (UUID) as stable keys

3. **Optional — `ActiveWorkoutManager.kt` + `ActiveWorkoutScreen.kt`:**
   - Add `moveExercise()` to ActiveWorkoutManager
   - Add drag reorder to active workout exercise cards
   - Lower priority (users typically order exercises in templates)

4. **Drag handle:** Add a grip/handle icon to each exercise card for discoverability

**Files:**
- `NewWorkoutViewModel.kt`, `NewWorkoutScreen.kt`
- Optionally: `ActiveWorkoutManager.kt`, `ActiveWorkoutScreen.kt`

---

## Database Migration Summary

| Version | Migration | Change |
|---------|-----------|--------|
| 1 → 2 | MIGRATION_1_2 (existing) | Added `bodyweight_entries` table |
| 2 → 3 | MIGRATION_2_3 (new) | Added `orderIndex` column to `workouts` table |

Only Feature 7 requires a schema migration. Feature 6 adds a new DAO query but no schema change.

---

## New Dependencies

| Library | Version | Purpose |
|---------|---------|---------|
| `sh.calvin.reorderable` | 2.4.3 | Drag-to-reorder for LazyColumn (Features 7 & 8) |

No other new dependencies. Coil (GIF), Room, DataStore, Navigation all already present.

---

## Testing Checklist

- [ ] **Feature 1:** Open app multiple times → different GIF each time. No internet → fallback emoji.
- [ ] **Feature 2:** Start rest timer → background app → alarm fires. Test with music playing. Test notification countdown. Test Skip from notification and in-app.
- [ ] **Feature 3:** Tap calendar day with workout → DayView loads. Tap exercise → sets expand. Tap again → collapse. Days without workouts show empty state.
- [ ] **Feature 4:** Focus any text input → keyboard opens → content above keyboard visible. Test on ActiveWorkout, NewWorkout, EditProfile, AddBodyweight dialog.
- [ ] **Feature 5:** Streak badge appears on Profile. Not on Home. Streak value matches expected calculation.
- [ ] **Feature 6:** Profile "View All Entries" → entries page. Set date range → filters. Edit weight → saves. Delete → removes. Back button works.
- [ ] **Feature 7:** Long-press workout → drag to reorder → release → order persists. Close and reopen → order preserved. New workout appears at bottom. Search mode → no drag.
- [ ] **Feature 8:** Long-press exercise in workout editor → drag to reorder. Save workout → order preserved. Load workout → exercises in correct order.
